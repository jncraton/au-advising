#!/usr/bin/env python3
import os
import re
import sys
from pathlib import Path


EXTS_TO_STRIP = (
    "pdf",
    "docx",
    "doc",
    "pptx",
    "xlsx",
    "html",
    "htm",
    "txt",
    "jpeg",
    "jpg",
    "png",
    "svg",
)


def strip_extra_extensions(stem: str) -> str:
    pattern = re.compile(r"\.({})$".format("|".join(EXTS_TO_STRIP)), flags=re.IGNORECASE)
    prev = None
    while prev != stem:
        prev = stem
        stem = pattern.sub("", stem)
    return stem


def strip_version_noise(stem: str) -> str:
    patterns = [
        r"[\-\.\s]rev\b",
        r"[\-\.\s]updated\b",
        r"[\-\.\s]revised\b",
        r"[\-\.\s]final\b",
        r"[\-\.\s]web\b",
        r"[\-\.\s]done\b",
        r"[\-\.\s]advising\b",
        r"[\-\.\s]sheet\b",
        r"[\-\.\s]major\b",
        r"[\-\.\s]docx\b",
        r"[\-\.\s]pdf\b",
        r"sent to marcomm",
        r"\d\d\d+\-\d+",
        r"\d\d\d\d",
        r"[\(\)\-\d\s]+$",
    ]
    for p in patterns:
        stem = re.sub(p, "", stem, flags=re.IGNORECASE)
    return stem


def normalize_filename(filename: str) -> str:
    p = Path(filename)
    if p.suffix.lower() != ".md":
        return filename
    stem = p.stem
    stem = re.sub(r"[\s\_\.\,\&]+", "-", stem)
    stem = strip_extra_extensions(stem)
    stem = strip_version_noise(stem)
    stem = re.sub(r"[\s\_\.\,]+", "-", stem)
    stem = re.sub(r"\-$", "", stem)
    stem = stem.lower()
    if not stem:
        stem = "readme"
    return stem + ".md"


def unique_destination(dest: Path) -> Path:
    if not dest.exists():
        return dest
    base = dest.stem
    suffix = dest.suffix
    counter = 1
    while True:
        candidate = dest.with_name(f"{base}-copy{counter}{suffix}")
        if not candidate.exists():
            return candidate
        counter += 1


def main(root: str = "references") -> int:
    root_path = Path(root)
    if not root_path.exists():
        print(f"Directory not found: {root}")
        return 2
    for dirpath, _, filenames in os.walk(root):
        for name in filenames:
            if not name.lower().endswith(".md"):
                continue
            src = Path(dirpath) / name
            new_name = normalize_filename(name)
            if new_name == name:
                continue
            dest = Path(dirpath) / new_name
            try:
                if dest.exists():
                    try:
                        if os.path.samefile(src, dest):
                            continue
                    except FileNotFoundError:
                        pass
                    dest = unique_destination(dest)
                if src.name == dest.name:
                    continue
                os.rename(src, dest)
                print(f"renamed: {src} -> {dest}")
            except Exception as e:
                print(f"failed to rename {src}: {e}")
    return 0


if __name__ == "__main__":
    root = sys.argv[1] if len(sys.argv) > 1 else "references"
    raise SystemExit(main(root))
